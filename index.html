<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Velora Music</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap');
        
        body { 
            font-family: 'Outfit', sans-serif; 
            background-color: #050505;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            color: #fff;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            overflow: hidden;
        }

        /* --- GLASSMORPHISM --- */
        .glass-panel {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            transform: translateZ(0);
        }

        .glass-nav {
            background: rgba(5, 5, 5, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-capsule {
            background: rgba(10, 10, 10, 0.9);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            transform: translateZ(0);
        }

        /* --- UI ELEMENTS --- */
        .nav-item.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.05);
        }
        .nav-item.inactive { color: #9ca3af; border: 1px solid transparent; }
        .nav-item.inactive:hover { color: white; background-color: rgba(255, 255, 255, 0.05); }
        
        .mobile-nav-item.active { color: #c084fc; }
        .mobile-nav-item.inactive { color: #6b7280; }

        /* Range Slider */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%;
            background: #fff; cursor: pointer; margin-top: -4px;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: rgba(255,255,255,0.2); border-radius: 2px;
        }

        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }

        .sidebar-transition {
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease, padding 0.3s ease;
        }

        /* --- VIDEO ENGINE CSS (Floating Logic) --- */
        #video-overlay {
            position: fixed;
            z-index: 50; /* Always on top */
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            pointer-events: none; /* Pass clicks through when hidden */
            opacity: 0;
            transition: opacity 0.3s ease, width 0.3s ease, height 0.3s ease, top 0.3s ease, left 0.3s ease, border-radius 0.3s ease, bottom 0.3s ease, right 0.3s ease;
            
            /* Default off-screen start */
            top: -1000px;
            left: -1000px;
            width: 1px;
            height: 1px;
        }

        #video-overlay.visible {
            opacity: 1;
            pointer-events: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }

        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .paused-spin { animation-play-state: paused !important; }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden flex flex-col md:flex-row p-0 md:p-4 gap-4 text-white">

    <aside class="glass-panel w-[280px] rounded-[30px] flex-col hidden md:flex overflow-hidden relative shrink-0 z-10">
        <div class="p-8 pb-4">
            <div class="mb-1">
                <h1 class="text-3xl font-bold tracking-tight text-white">Velora Music</h1>
            </div>
            <p class="text-[10px] text-gray-400 font-medium tracking-[0.2em] uppercase opacity-70 ml-1">Sonic Experience</p>
        </div>
        <nav class="flex-1 px-4 py-2 space-y-2">
            <div onclick="switchTab('home')" id="d-nav-home" class="nav-item active flex items-center gap-4 px-4 py-3 rounded-xl cursor-pointer transition-all duration-300">
                <i class="fas fa-home text-lg"></i> <span class="font-semibold">Home</span>
            </div>
            <div onclick="switchTab('search')" id="d-nav-search" class="nav-item inactive flex items-center gap-4 px-4 py-3 rounded-xl cursor-pointer transition-all duration-300">
                <i class="fas fa-search text-lg"></i> <span class="font-semibold">Discover</span>
            </div>
            
            <div class="mt-8 px-4">
                <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4">Your Collection</h3>
                <div class="space-y-3">
                    <div class="flex items-center gap-3 text-gray-300 hover:text-white cursor-pointer transition group">
                        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center shadow-lg transition">
                            <i class="fas fa-heart text-xs text-white"></i>
                        </div>
                        <span class="text-sm font-medium">Liked Songs</span>
                    </div>
                </div>
            </div>
        </nav>
        
        <div class="p-4 mt-auto">
            <div class="bg-black/40 rounded-2xl p-3 flex items-center gap-3 border border-white/5 cursor-pointer hover:bg-black/60 transition">
                <img src="https://ui-avatars.com/api/?name=User&background=1e1b4b&color=fff" class="w-10 h-10 rounded-full border-2 border-purple-500/30">
                <div>
                    <h4 class="text-sm font-bold">My Account</h4>
                    <p class="text-xs text-gray-400">Premium</p>
                </div>
                <i class="fas fa-cog ml-auto text-gray-500 hover:text-white transition"></i>
            </div>
        </div>
    </aside>

    <main class="flex-1 md:glass-panel md:rounded-[30px] overflow-hidden flex flex-col relative w-full h-full transition-all duration-300 z-0">
        
        <header class="absolute top-0 left-0 w-full z-20 px-4 md:px-8 py-4 md:py-6 flex justify-between items-center bg-gradient-to-b from-black/80 to-transparent backdrop-blur-sm md:backdrop-blur-none md:bg-none">
            <div class="md:hidden flex items-center gap-2">
                <span class="font-bold text-xl">Velora Music</span>
            </div>

            <div id="search-bar-container" class="hidden relative group flex-1 ml-4 md:ml-0 md:flex-none md:w-[350px]">
                <i class="fas fa-search absolute left-4 top-3.5 text-gray-400"></i>
                <input id="search-input" type="text" placeholder="Search songs..." class="w-full bg-white/10 border border-white/10 rounded-full py-2.5 pl-10 pr-4 text-sm text-white focus:outline-none focus:bg-black/80 backdrop-blur-md">
            </div>
            
            <div class="hidden md:flex gap-4 ml-auto">
                <button class="w-10 h-10 rounded-full bg-white/5 border border-white/10 flex items-center justify-center hover:bg-white/10"><i class="far fa-bell text-gray-300"></i></button>
            </div>
        </header>

        <div id="main-view" class="flex-1 overflow-y-auto pb-48 md:pb-32 pt-20 px-4 md:px-8 hide-scroll scroll-smooth">
            
            <div id="view-home" class="animate-fade-in space-y-10">
                
                <div class="w-full h-[220px] rounded-[25px] bg-gradient-to-r from-violet-900 to-fuchsia-900 relative overflow-hidden shadow-2xl group cursor-pointer">
                    <img src="https://images.unsplash.com/photo-1493225255756-d9584f8606e9?w=800" class="absolute inset-0 w-full h-full object-cover mix-blend-overlay opacity-60 transition duration-700 group-hover:scale-105">
                    <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent"></div>
                    <div class="absolute bottom-6 left-6 z-10 pr-6">
                        <span class="text-[10px] font-bold tracking-widest uppercase bg-white/20 backdrop-blur-md px-2 py-1 rounded text-white mb-2 inline-block border border-white/10">Featured Mix</span>
                        <h2 class="text-3xl font-bold mb-1 leading-tight">Midnight Jazz</h2>
                        <p class="text-gray-300 text-sm mb-3 line-clamp-1">The smoothest tracks for late night vibes.</p>
                        <button onclick="playTrack('kgx4WGK0oNU')" class="bg-white text-black w-10 h-10 rounded-full flex items-center justify-center hover:scale-110 transition">
                            <i class="fas fa-play ml-0.5"></i>
                        </button>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between items-end mb-4 px-1">
                        <h2 class="text-xl font-bold">Trending Songs</h2>
                        <span class="text-xs text-gray-400 hover:text-white cursor-pointer uppercase font-bold tracking-wider">Show all</span>
                    </div>
                    <div class="flex overflow-x-auto gap-4 pb-4 hide-scroll snap-x" id="trending-container">
                        </div>
                </div>

                <div>
                    <h2 class="text-xl font-bold mb-4 px-1">Popular Artists</h2>
                    <div class="flex overflow-x-auto gap-6 pb-4 hide-scroll snap-x" id="artists-container">
                        <div class="flex flex-col items-center gap-2 min-w-[100px] cursor-pointer group snap-start">
                            <div class="w-24 h-24 rounded-full overflow-hidden border-2 border-transparent group-hover:border-purple-500 transition shadow-lg"><img src="https://i.ytimg.com/vi/D4VTe_ajEbM/hqdefault.jpg" class="w-full h-full object-cover"></div>
                            <span class="text-sm font-medium text-center group-hover:text-white text-gray-300">Arijit Singh</span>
                        </div>
                        <div class="flex flex-col items-center gap-2 min-w-[100px] cursor-pointer group snap-start">
                            <div class="w-24 h-24 rounded-full overflow-hidden border-2 border-transparent group-hover:border-purple-500 transition shadow-lg"><img src="https://i.ytimg.com/vi/wtPcVgiZ2nE/hqdefault.jpg" class="w-full h-full object-cover"></div>
                            <span class="text-sm font-medium text-center group-hover:text-white text-gray-300">Anuv Jain</span>
                        </div>
                        <div class="flex flex-col items-center gap-2 min-w-[100px] cursor-pointer group snap-start">
                            <div class="w-24 h-24 rounded-full overflow-hidden border-2 border-transparent group-hover:border-purple-500 transition shadow-lg"><img src="https://i.ytimg.com/vi/M3KqF_yX_7c/hqdefault.jpg" class="w-full h-full object-cover"></div>
                            <span class="text-sm font-medium text-center group-hover:text-white text-gray-300">Faheem Abdullah</span>
                        </div>
                        <div class="flex flex-col items-center gap-2 min-w-[100px] cursor-pointer group snap-start">
                            <div class="w-24 h-24 rounded-full overflow-hidden border-2 border-transparent group-hover:border-purple-500 transition shadow-lg"><img src="https://i.ytimg.com/vi/rm5-KhqwqeQ/hqdefault.jpg" class="w-full h-full object-cover"></div>
                            <span class="text-sm font-medium text-center group-hover:text-white text-gray-300">A.R. Rahman</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-search" class="hidden animate-fade-in pt-4">
                <h2 class="text-2xl font-bold mb-6">Discover</h2>
                <div id="search-results-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
            </div>
        </div>
    </main>

    <div id="video-overlay">
        <div id="youtube-player"></div>
    </div>

    <aside id="right-sidebar" class="glass-panel rounded-[30px] hidden xl:flex flex-col overflow-hidden gap-4 sidebar-transition w-0 p-0 opacity-0 shrink-0 z-10">
        <div class="flex justify-between items-center mb-1 min-w-[260px]">
            <span class="font-bold text-white">Now Playing</span>
            <button onclick="toggleSidebar()" class="w-7 h-7 flex items-center justify-center rounded-full bg-white/5 hover:bg-white/20 transition text-gray-400 hover:text-white">
                <i class="fas fa-list text-sm"></i>
            </button>
        </div>
        <div id="sidebar-video-slot" class="w-full aspect-video rounded-xl overflow-hidden bg-white/5 min-w-[260px] border border-white/10"></div>
        <div class="flex-1 bg-white/5 rounded-xl p-4 overflow-y-auto min-w-[260px]">
            <h4 class="text-xs font-bold text-gray-500 uppercase mb-3">Up Next</h4>
            <div class="text-sm text-gray-400 text-center mt-10">Queue is empty</div>
        </div>
    </aside>

    <nav class="md:hidden fixed bottom-0 left-0 w-full glass-nav z-50 flex justify-around items-center h-[70px] pb-2">
        <div onclick="switchTab('home')" id="m-nav-home" class="mobile-nav-item active flex flex-col items-center justify-center w-full h-full">
            <i class="fas fa-home text-xl mb-1"></i>
            <span class="text-[10px] font-medium">Home</span>
        </div>
        <div onclick="switchTab('search')" id="m-nav-search" class="mobile-nav-item inactive flex flex-col items-center justify-center w-full h-full">
            <i class="fas fa-search text-xl mb-1"></i>
            <span class="text-[10px] font-medium">Search</span>
        </div>
    </nav>

    <div class="fixed bottom-[80px] md:bottom-6 left-1/2 -translate-x-1/2 w-[92%] md:w-[95%] max-w-5xl h-[70px] md:h-[88px] glass-capsule rounded-full z-40 flex items-center justify-between px-2 md:px-2 md:pr-8 shadow-2xl transition-all duration-500" id="music-player">
        <div class="flex items-center gap-3 pl-1 md:pl-2 w-[60%] md:w-[30%] overflow-hidden">
            <div class="relative w-12 h-12 md:w-16 md:h-16 rounded-full overflow-hidden border-2 border-white/10 shadow-lg flex-shrink-0">
                <img id="player-art" src="https://images.unsplash.com/photo-1493225255756-d9584f8606e9?w=200" class="w-full h-full object-cover animate-[spin-slow_8s_linear_infinite] paused-spin">
            </div>
            <div class="overflow-hidden">
                <h4 id="player-title" class="font-bold text-white text-xs md:text-sm truncate pr-2">Select Song</h4>
                <p id="player-artist" class="text-[10px] md:text-xs text-gray-400 truncate">Velora</p>
            </div>
        </div>
        <div class="flex flex-col items-end md:items-center justify-center flex-1 md:max-w-md px-2 md:px-4">
            <div class="flex items-center gap-4 md:gap-6 mb-1">
                <button onclick="prevSong()" class="text-white hover:text-purple-400 hidden md:block"><i class="fas fa-step-backward text-lg"></i></button>
                <button onclick="togglePlay()" class="w-10 h-10 md:w-10 md:h-10 rounded-full bg-white text-black flex items-center justify-center hover:scale-105 active:scale-95 transition shadow-lg">
                    <i id="play-icon" class="fas fa-play ml-0.5"></i>
                </button>
                <button onclick="nextSong()" class="text-white hover:text-purple-400 hidden md:block"><i class="fas fa-step-forward text-lg"></i></button>
            </div>
            <div class="w-24 md:w-full flex items-center gap-2 text-[10px] text-gray-400 font-mono">
                <div class="flex-1 relative h-1 bg-white/10 rounded-full cursor-pointer">
                    <input type="range" id="progress-slider" min="0" max="100" value="0" class="absolute w-full h-full opacity-0 z-20 cursor-pointer" oninput="seekSong()">
                    <div id="progress-fill" class="absolute top-0 left-0 h-full bg-gradient-to-r from-purple-500 to-indigo-500 rounded-full w-0 z-10 pointer-events-none"></div>
                </div>
            </div>
        </div>
        <div class="hidden md:flex items-center gap-4 w-[30%] justify-end">
            <button onclick="toggleSidebar()" class="text-gray-400 hover:text-white transition" title="Open/Close Queue"><i class="fas fa-list text-sm"></i></button>
            <div class="flex items-center gap-3">
                <i class="fas fa-volume-up text-xs text-gray-400"></i>
                <div class="w-20 relative h-1 bg-white/10 rounded-full">
                    <input type="range" id="volume-slider" min="0" max="100" value="100" class="absolute w-full h-full opacity-0 z-20 cursor-pointer" oninput="setVolume()">
                    <div id="volume-fill" class="absolute top-0 left-0 h-full bg-white w-full z-10 rounded-full pointer-events-none"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        var player;
        var isPlayerReady = false;

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('youtube-player', {
                height: '100%',
                width: '100%',
                playerVars: { 'playsinline': 1, 'controls': 1, 'enablejsapi': 1, 'origin': window.location.origin },
                events: { 
                    'onReady': onPlayerReady, 
                    'onStateChange': onPlayerStateChange,
                    'onError': onPlayerError 
                }
            });
        }

        function onPlayerReady(event) {
            isPlayerReady = true;
            setVolume();
            updateVideoPosition();
        }

        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.PLAYING) {
                isPlaying = true;
                document.getElementById('play-icon').classList.remove('fa-play', 'ml-0.5');
                document.getElementById('play-icon').classList.add('fa-pause');
                document.getElementById('player-art').style.animationPlayState = 'running';
                document.getElementById('video-overlay').classList.add('visible');
                startProgressLoop();
            } else if (event.data == YT.PlayerState.PAUSED) {
                isPlaying = false;
                document.getElementById('play-icon').classList.remove('fa-pause');
                document.getElementById('play-icon').classList.add('fa-play', 'ml-0.5');
                document.getElementById('player-art').style.animationPlayState = 'paused';
                stopProgressLoop();
            } else if (event.data == YT.PlayerState.ENDED) {
                nextSong();
            }
        }

        function onPlayerError(event) {
            console.log("Video Unavailable. Skipping...", event.data);
            setTimeout(nextSong, 500);
        }

        // --- UPDATED LIBRARY ---
        // Includes: Pardesiya, O Maahi, and Satranga
        const library = [
            // 0. Banner Track (Hidden from trending list)
            { id: 'kgx4WGK0oNU', title: "Midnight Jazz", artist: "Velora Mix", img: "https://images.unsplash.com/photo-1493225255756-d9584f8606e9?w=800", isTrending: false },
            
            // 1. Saiyaara 
            { id: 'HQp0DwtTP18', title: "Saiyaara", artist: "Faheem Abdullah", img: "https://i.ytimg.com/vi/HQp0DwtTP18/hqdefault.jpg", isTrending: true },
            
            // 2. Barbaad 
            { id: '8WOhUueYAZs', title: "Barbaad", artist: "Jubin Nautiyal", img: "https://i.ytimg.com/vi/8WOhUueYAZs/hqdefault.jpg", isTrending: true },
            
            // 3. Dhun 
            { id: 'COuGgctJ91A', title: "Dhun", artist: "Arijit Singh", img: "https://i.ytimg.com/vi/COuGgctJ91A/hqdefault.jpg", isTrending: true },
            
            // 4. Jo Tum Mere Ho 
            { id: 'wmUJwQNGK3k', title: "Jo Tum Mere Ho", artist: "Anuv Jain", img: "https://i.ytimg.com/vi/wmUJwQNGK3k/hqdefault.jpg", isTrending: true },
            
            // 5. Tere Bina 
            { id: 'rm5-KhqwqeQ', title: "Tere Bina", artist: "A.R. Rahman", img: "https://i.ytimg.com/vi/rm5-KhqwqeQ/hqdefault.jpg", isTrending: true },
            
            // 6. Ishq 
            { id: 'yVhhoyfLDfA', title: "Ishq", artist: "Faheem Abdullah", img: "https://i.ytimg.com/vi/yVhhoyfLDfA/hqdefault.jpg", isTrending: true },
            
            // 7. Tum Hi Ho 
            { id: 'asxmdFaIock', title: "Tum Hi Ho", artist: "Arijit Singh", img: "https://i.ytimg.com/vi/asxmdFaIock/hqdefault.jpg", isTrending: true },

            // 8. Pardesiya (New)
            { id: '_wjtdQs0cqc', title: "Pardesiya", artist: "Sonu Nigam, Sachin-Jigar", img: "https://i.ytimg.com/vi/_wjtdQs0cqc/hqdefault.jpg", isTrending: true },

            // 9. O Maahi (New)
            { id: 'Ref5bT8Tuk8', title: "O Maahi", artist: "Arijit Singh", img: "https://i.ytimg.com/vi/Ref5bT8Tuk8/hqdefault.jpg", isTrending: true },

            // 10. Satranga (New)
            { id: '9DGgiYYPr58', title: "Satranga", artist: "Arijit Singh", img: "https://i.ytimg.com/vi/9DGgiYYPr58/hqdefault.jpg", isTrending: true }
        ];

        let isPlaying = false;
        let currentSongIndex = 0;
        let progressInterval;

        window.onload = () => {
            renderTrendingRow();
            // Sync Loop (Updates position every 50ms)
            setInterval(updateVideoPosition, 50);
            window.addEventListener('resize', updateVideoPosition);
        };

        // --- POSITION SYNCING (No-Reload Logic) ---
        function updateVideoPosition() {
            const overlay = document.getElementById('video-overlay');
            const sidebar = document.getElementById('right-sidebar');
            const placeholder = document.getElementById('sidebar-video-slot');
            const isDesktop = window.innerWidth >= 1280;
            // Sidebar is "open" if width > 0
            const isSidebarOpen = sidebar && sidebar.offsetWidth > 10; 
            const songSelected = document.getElementById('player-title').innerText !== "Select Song";

            if (!songSelected) {
                overlay.classList.remove('visible');
                return;
            }

            if (isDesktop && isSidebarOpen && placeholder) {
                // Sidebar Mode: Match placeholder exact rect
                const rect = placeholder.getBoundingClientRect();
                overlay.style.width = rect.width + 'px';
                overlay.style.height = rect.height + 'px';
                overlay.style.top = rect.top + 'px';
                overlay.style.left = rect.left + 'px';
                overlay.style.bottom = 'auto';
                overlay.style.right = 'auto';
                overlay.style.borderRadius = '12px';
                overlay.style.zIndex = '40';
            } else {
                // PiP Mode
                overlay.style.width = '160px';
                overlay.style.height = '90px';
                overlay.style.bottom = window.innerWidth < 768 ? '90px' : '100px';
                overlay.style.right = '16px';
                overlay.style.top = 'auto';
                overlay.style.left = 'auto';
                overlay.style.zIndex = '60'; // Topmost
                overlay.style.borderRadius = '8px';
            }
            
            if(songSelected) overlay.classList.add('visible');
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('right-sidebar');
            if (sidebar.classList.contains('w-0')) {
                // OPEN
                sidebar.classList.remove('w-0', 'p-0', 'opacity-0');
                sidebar.classList.add('w-[300px]', 'p-4', 'opacity-100');
            } else {
                // CLOSE
                sidebar.classList.add('w-0', 'p-0', 'opacity-0');
                sidebar.classList.remove('w-[300px]', 'p-4', 'opacity-100');
            }
        }

        function renderTrendingRow() {
            const container = document.getElementById('trending-container');
            
            // --- UPDATED LOGIC: Filter by flag instead of index slice ---
            const trendingSongs = library.filter(s => s.isTrending);

            if(trendingSongs.length === 0) {
                container.innerHTML = `<p class="text-gray-500 pl-2">No trending songs.</p>`;
                return;
            }

            container.innerHTML = trendingSongs.map((song, idx) => `
            <div onclick="playTrack('${song.id}')" class="min-w-[140px] w-[140px] bg-white/5 p-3 rounded-xl border border-white/5 active:bg-white/10 cursor-pointer group transition snap-start">
                <div class="relative mb-2">
                    <img src="${song.img}" class="w-full aspect-square object-cover rounded-lg shadow-lg">
                    <div class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition duration-300 rounded-lg backdrop-blur-[1px]">
                        <div class="w-8 h-8 bg-white rounded-full flex items-center justify-center text-black shadow-xl scale-0 group-hover:scale-100 transition duration-300">
                            <i class="fas fa-play pl-0.5 text-xs"></i>
                        </div>
                    </div>
                </div>
                <h3 class="font-bold text-white text-sm truncate">${song.title}</h3>
                <p class="text-[10px] text-gray-400 mt-0.5">${song.artist}</p>
            </div>`).join('');
        }

        function playTrack(videoId, index) {
            let song = library.find(s => s.id === videoId);
            if(!song) song = { title: "Unknown", artist: "YouTube", img: "https://placehold.co/200" }; 

            if (typeof index === 'number') currentSongIndex = index;
            else currentSongIndex = library.findIndex(s => s.id === videoId);

            document.getElementById('player-title').innerText = song.title;
            document.getElementById('player-artist').innerText = song.artist;
            document.getElementById('player-art').src = song.img;

            if(isPlayerReady) {
                player.loadVideoById(videoId);
                // Auto-open sidebar on Desktop if closed
                if(window.innerWidth >= 1280) {
                    const sidebar = document.getElementById('right-sidebar');
                    if(sidebar.classList.contains('w-0')) toggleSidebar();
                }
            }

            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: song.title,
                    artist: song.artist,
                    artwork: [{ src: song.img, sizes: '512x512', type: 'image/jpeg' }]
                });
                navigator.mediaSession.setActionHandler('play', function() { togglePlay(); });
                navigator.mediaSession.setActionHandler('pause', function() { togglePlay(); });
                navigator.mediaSession.setActionHandler('previoustrack', function() { prevSong(); });
                navigator.mediaSession.setActionHandler('nexttrack', function() { nextSong(); });
            }
        }

        function togglePlay() { if(isPlayerReady) isPlaying ? player.pauseVideo() : player.playVideo(); }

        function nextSong() {
            currentSongIndex++;
            if (currentSongIndex >= library.length) currentSongIndex = 0;
            playTrack(library[currentSongIndex].id, currentSongIndex);
        }

        function prevSong() {
            currentSongIndex--;
            if (currentSongIndex < 0) currentSongIndex = library.length - 1;
            playTrack(library[currentSongIndex].id, currentSongIndex);
        }

        function startProgressLoop() {
            clearInterval(progressInterval);
            progressInterval = setInterval(() => {
                if(!player || !player.getCurrentTime) return;
                const current = player.getCurrentTime();
                const total = player.getDuration();
                if(total > 0) {
                    const percent = (current / total) * 100;
                    document.getElementById('progress-slider').value = percent;
                    document.getElementById('progress-fill').style.width = percent + '%';
                }
            }, 1000);
        }

        function stopProgressLoop() { clearInterval(progressInterval); }

        function seekSong() {
            if(!isPlayerReady) return;
            const slideVal = document.getElementById('progress-slider').value;
            const total = player.getDuration();
            player.seekTo((slideVal / 100) * total, true);
        }

        function setVolume() {
            if(!isPlayerReady) return;
            const vol = document.getElementById('volume-slider').value;
            player.setVolume(vol);
            document.getElementById('volume-fill').style.width = vol + '%';
        }

        const searchInput = document.getElementById('search-input');
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            // Filter starting from index 1 to skip the banner track in search results
            const results = library.slice(1).filter(s => s.title.toLowerCase().includes(query) || s.artist.toLowerCase().includes(query));
            const resultsGrid = document.getElementById('search-results-grid');
            if (results.length > 0) {
                resultsGrid.innerHTML = results.map((song, idx) => `
                <div onclick="playTrack('${song.id}')" class="bg-white/5 p-3 rounded-2xl border border-white/5 active:bg-white/10 cursor-pointer">
                    <img src="${song.img}" class="w-full aspect-square object-cover rounded-xl mb-2">
                    <h3 class="font-bold text-white text-sm truncate">${song.title}</h3>
                    <p class="text-xs text-gray-400">${song.artist}</p>
                </div>`).join('');
            } else {
                resultsGrid.innerHTML = `<p class="text-gray-500 col-span-full text-center mt-10">No results found.</p>`;
            }
        });

        function switchTab(tabId) {
            document.querySelectorAll('.nav-item').forEach(el => { el.classList.remove('active'); el.classList.add('inactive'); });
            const dNav = document.getElementById('d-nav-' + tabId);
            if(dNav) { dNav.classList.add('active'); dNav.classList.remove('inactive'); }
            document.querySelectorAll('.mobile-nav-item').forEach(el => { el.classList.remove('active'); el.classList.add('inactive'); });
            const mNav = document.getElementById('m-nav-' + tabId);
            if(mNav) { mNav.classList.add('active'); mNav.classList.remove('inactive'); }
            
            document.getElementById('view-home').classList.add('hidden');
            document.getElementById('view-search').classList.add('hidden');
            document.getElementById('view-' + tabId).classList.remove('hidden');
            
            const sb = document.getElementById('search-bar-container');
            tabId === 'search' ? sb.classList.remove('hidden') : sb.classList.add('hidden');
        }
    </script>
</body>
</html>
